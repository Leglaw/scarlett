<!-- omit in toc -->
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 586 55" style="enable-background:new 0 0 586 55;" xml:space="preserve">
<g>
	<path d="M34.25,10.35c0.48,0.34,0.72,0.67,0.72,1.01c0,0.24-0.17,0.55-0.5,0.94l-1.3,1.58c-0.34,0.48-0.65,0.72-0.94,0.72
		c-0.34,0-0.7-0.17-1.08-0.5c-2.02-1.44-4.07-2.57-6.16-3.38c-2.09-0.82-4.31-1.22-6.66-1.22c-2.11,0-3.98,0.36-5.62,1.08
		c-1.63,0.72-2.9,1.76-3.82,3.13c-0.91,1.37-1.37,2.99-1.37,4.86s0.44,3.41,1.33,4.61c0.89,1.2,2.2,2.18,3.92,2.95
		c1.73,0.77,4.08,1.54,7.06,2.3c3.7,0.96,6.65,2.03,8.86,3.2c2.21,1.18,3.86,2.63,4.97,4.36c1.1,1.73,1.66,3.86,1.66,6.41
		c0,2.83-0.77,5.33-2.3,7.49c-1.54,2.16-3.65,3.84-6.34,5.04c-2.69,1.2-5.74,1.8-9.14,1.8c-3.12,0-6.06-0.56-8.82-1.69
		c-2.76-1.13-5.29-2.65-7.6-4.57c-0.48-0.34-0.72-0.67-0.72-1.01c0-0.29,0.17-0.62,0.5-1.01l1.37-1.66
		c0.34-0.43,0.65-0.65,0.94-0.65c0.19,0,0.5,0.17,0.94,0.5c4.51,3.65,9.05,5.47,13.61,5.47c2.54,0,4.76-0.38,6.66-1.15
		c1.9-0.77,3.36-1.86,4.39-3.28c1.03-1.42,1.55-3.08,1.55-5c0-1.78-0.4-3.23-1.19-4.36c-0.79-1.13-2.06-2.11-3.82-2.95
		c-1.75-0.84-4.21-1.67-7.38-2.48c-3.5-0.91-6.35-1.9-8.53-2.95c-2.19-1.06-3.88-2.47-5.08-4.25c-1.2-1.78-1.8-4.06-1.8-6.84
		c0-2.83,0.71-5.3,2.12-7.42c1.42-2.11,3.32-3.73,5.72-4.86c2.4-1.13,5.09-1.69,8.06-1.69C24.24,4.88,29.5,6.7,34.25,10.35z"/>
	<path d="M110.2,50.64c2.62-0.98,5-2.39,7.16-4.21c0.48-0.38,0.86-0.58,1.15-0.58c0.34,0,0.65,0.22,0.94,0.65l1.08,1.44
		c0.24,0.38,0.36,0.67,0.36,0.86c0,0.34-0.24,0.72-0.72,1.15c-2.54,2.16-5.41,3.83-8.6,5c-3.19,1.18-6.54,1.76-10.04,1.76
		c-4.51,0-8.69-1.1-12.53-3.31c-3.84-2.21-6.89-5.28-9.14-9.22c-2.26-3.94-3.38-8.35-3.38-13.25s1.13-9.32,3.38-13.28
		c2.26-3.96,5.33-7.08,9.22-9.36c3.89-2.28,8.18-3.42,12.89-3.42c3.41,0,6.67,0.6,9.79,1.8c3.12,1.2,5.9,2.81,8.35,4.82
		c0.43,0.34,0.65,0.67,0.65,1.01c0,0.24-0.14,0.58-0.43,1.01l-1.08,1.37c-0.38,0.48-0.72,0.72-1.01,0.72c-0.14,0-0.31-0.06-0.5-0.18
		c-0.19-0.12-0.41-0.25-0.65-0.4c-2.16-1.73-4.55-3.08-7.16-4.07c-2.62-0.98-5.34-1.48-8.17-1.48c-3.74,0-7.16,0.91-10.26,2.74
		c-3.1,1.82-5.56,4.36-7.38,7.6c-1.82,3.24-2.74,6.92-2.74,11.05c0,3.94,0.9,7.52,2.7,10.76c1.8,3.24,4.26,5.8,7.38,7.67
		c3.12,1.87,6.55,2.81,10.3,2.81C104.77,52.11,107.58,51.62,110.2,50.64z"/>
	<path d="M164.65,53.91c-0.38,0.86-0.74,1.43-1.08,1.69c-0.34,0.26-0.86,0.4-1.58,0.4h-1.3c-0.48,0-0.84-0.07-1.08-0.22
		c-0.24-0.14-0.36-0.38-0.36-0.72c0-0.19,0.12-0.58,0.36-1.15l21.1-45.65c0.38-0.86,0.73-1.58,1.04-2.16
		c0.31-0.58,0.56-0.95,0.76-1.12c0.19-0.17,0.43-0.25,0.72-0.25c0.24,0,0.46,0.08,0.65,0.25c0.19,0.17,0.44,0.54,0.76,1.12
		c0.31,0.58,0.66,1.3,1.04,2.16l21.24,45.65c0.24,0.58,0.36,0.96,0.36,1.15c0,0.34-0.12,0.58-0.36,0.72
		c-0.24,0.14-0.6,0.22-1.08,0.22h-1.51c-0.72,0-1.25-0.13-1.58-0.4c-0.34-0.26-0.7-0.83-1.08-1.69l-18.5-40.46L164.65,53.91z"/>
	<path d="M253.21,55.71C253,55.9,252.63,56,252.1,56h-1.8c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V7.04
		c0-0.58,0.11-0.96,0.32-1.15c0.22-0.19,0.59-0.29,1.12-0.29h12.46c6.62,0,11.56,1.28,14.8,3.85c3.24,2.57,4.86,6.28,4.86,11.12
		c0,3.6-0.92,6.54-2.77,8.82c-1.85,2.28-4.4,3.9-7.67,4.86l13.1,19.66c0.43,0.62,0.65,1.1,0.65,1.44c0,0.24-0.13,0.41-0.4,0.5
		c-0.26,0.1-0.66,0.14-1.19,0.14h-1.8c-0.72,0-1.26-0.11-1.62-0.32c-0.36-0.22-0.8-0.73-1.33-1.55l-14.04-21.46
		c-0.24-0.38-0.36-0.7-0.36-0.94c0-0.19,0.06-0.32,0.18-0.4c0.12-0.07,0.35-0.13,0.68-0.18c3.65-0.29,6.49-1.26,8.53-2.92
		c2.04-1.66,3.06-4.19,3.06-7.6c0-3.65-1.3-6.3-3.89-7.96c-2.59-1.66-6.31-2.48-11.16-2.48h-8.14c-0.48,0-0.72,0.24-0.72,0.72v43.63
		C253.54,55.14,253.43,55.52,253.21,55.71z"/>
	<path d="M333.44,51.39h22.61c0.53,0,0.9,0.1,1.12,0.29c0.22,0.19,0.32,0.58,0.32,1.15v1.73c0,0.58-0.11,0.96-0.32,1.15
		c-0.22,0.19-0.59,0.29-1.12,0.29h-26.57c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V7.04
		c0-0.58,0.11-0.96,0.32-1.15c0.22-0.19,0.59-0.29,1.12-0.29h1.8c0.53,0,0.9,0.1,1.12,0.29c0.22,0.19,0.32,0.58,0.32,1.15v43.63
		C332.72,51.15,332.96,51.39,333.44,51.39z"/>
	<path d="M428.77,51.68c0.22,0.19,0.32,0.58,0.32,1.15v1.73c0,0.58-0.11,0.96-0.32,1.15c-0.22,0.19-0.59,0.29-1.12,0.29h-25.85
		c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V7.04c0-0.58,0.11-0.96,0.32-1.15c0.22-0.19,0.59-0.29,1.12-0.29h25.78
		c0.53,0,0.9,0.1,1.12,0.29c0.21,0.19,0.32,0.58,0.32,1.15v1.73c0,0.58-0.11,0.96-0.32,1.15c-0.22,0.19-0.59,0.29-1.12,0.29h-21.82
		c-0.48,0-0.72,0.24-0.72,0.72v16.7c0,0.48,0.24,0.72,0.72,0.72h19.37c0.53,0,0.9,0.1,1.12,0.29c0.22,0.19,0.32,0.58,0.32,1.15v1.66
		c0,0.58-0.11,0.96-0.32,1.15c-0.21,0.19-0.59,0.29-1.12,0.29h-19.37c-0.48,0-0.72,0.24-0.72,0.72v17.06c0,0.48,0.24,0.72,0.72,0.72
		h21.89C428.18,51.39,428.55,51.49,428.77,51.68z"/>
	<path d="M507.9,9.92c-0.22,0.19-0.59,0.29-1.12,0.29h-14.62c-0.48,0-0.72,0.24-0.72,0.72v43.63c0,0.58-0.11,0.96-0.32,1.15
		c-0.21,0.19-0.59,0.29-1.12,0.29h-1.8c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V10.93c0-0.48-0.24-0.72-0.72-0.72
		h-14.62c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V7.04c0-0.58,0.11-0.96,0.32-1.15c0.22-0.19,0.59-0.29,1.12-0.29
		h35.35c0.53,0,0.9,0.1,1.12,0.29c0.22,0.19,0.32,0.58,0.32,1.15v1.73C508.22,9.34,508.11,9.73,507.9,9.92z"/>
	<path d="M585.63,9.92c-0.22,0.19-0.59,0.29-1.12,0.29H569.9c-0.48,0-0.72,0.24-0.72,0.72v43.63c0,0.58-0.11,0.96-0.32,1.15
		c-0.22,0.19-0.59,0.29-1.12,0.29h-1.8c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V10.93c0-0.48-0.24-0.72-0.72-0.72
		h-14.62c-0.53,0-0.9-0.1-1.12-0.29c-0.22-0.19-0.32-0.58-0.32-1.15V7.04c0-0.58,0.11-0.96,0.32-1.15c0.22-0.19,0.59-0.29,1.12-0.29
		h35.35c0.53,0,0.9,0.1,1.12,0.29c0.22,0.19,0.32,0.58,0.32,1.15v1.73C585.95,9.34,585.84,9.73,585.63,9.92z"/>
</g>
</svg>

> A strongly typed, Typescript powered, rest client library based on Fetch API.

<!-- omit in toc -->
## Key features

* [Fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API) based rest client
* Class based
* Strongly-typed (...thank you Typescript)
* Centralized config (via constructor)...with optional local overrides on http methods
* Response body auto-translation, based on fetch's [Body](https://developer.mozilla.org/en-US/docs/Web/API/Body)
* Built-in cache
* Query-string utilities
* Optional Error object's intellisense
* Optional throw errors on request failures
* Optional catch-filters to handle expected errors even when throw error is enabled
* Support for timeout
* Easy request repeater

<!-- omit in toc -->
## Summary

- [Installation](#installation)
	- [Required Polyfills](#required-polyfills)
	- [Different builds](#different-builds)
- [Basic Usage](#basic-usage)
- [RestClient](#restclient)
	- [Instance Options](#instance-options)
	- [Response Object](#response-object)
	- [Request (sent) Object](#request-sent-object)
- [RestError](#resterror)
- [Advanced usage](#advanced-usage)
	- [Extending](#extending)
	- [Importing extras](#importing-extras)
- [Testing](#testing)
- [Inspired by...](#inspired-by)
- [Why this name?](#why-this-name)


## Installation

`npm i scarlett`

or

`yarn add scarlett`

### Required Polyfills

As `tsconfig.json`, sources are compiled to`ES2019`, keep in mind that **polyfills are not included**.

Scarlett will require the following APIs:

* [Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)
* [Fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)
* [Headers](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#Headers)
* [URL](https://developer.mozilla.org/en-US/docs/Web/API/URL/URL)
* [Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)

### Different builds

In the `lib/` folder of the package you will find different build files:

| Format                    | Filename              |
| ------------------------- | --------------------- |
| **ES Module**Â *(default)* | `index.js`        |
| **UMD**                   | `index.umd.js`        |
| **CommonJs**              | `index.common.js`     |
| **CommonJs ES3**          | `index.es3.common.js` |

## Basic Usage

1. Import the library:

	```typescript
	import RestClient from `scarlett`
	```

2. Create a rest client in stance providing an object of interface `IRequestOptions`.

	```typescript
	const client = new RestClient({
		host: `https://server.com`,
		responseType: `text`
	} /* >> IRequestOptions  */)
	const response = await client.get<string>(`path`)
	```

Every request method will return a `Promise<IResponse<T>>`.

See the `tests/features.test.ts` to see it in action!

## RestClient

### Instance Options

To create a new rest client instance, you need to use the `IRequestOptions` interface.

You can override any property provided at every request method:

```typescript
const client = new RestClient({
	host: `https://server.com`,
	responseType: `text`
})
const response = await client.get<any>(`/my-json-path`, { responseType: `json` })
```

Here is the list of properties:

**host (string)**

Defaults to localhost.href .

**basePath (string)**

The base path to use on every request, defaults to `/`.

**responseType (HttpResponseFormat)**

One of the following: `json` (default), `text`, `blob`, `arrayBuffer`, `formData`.

This property will translate the response body, using the proper type. For example, when you set `json` as responseType you don't need to `JSON.parse(response.data)`.

**body**

Optional request body content, aving one of the following instances: `ArrayBuffer`, `ArrayBufferView`, `Blob`, `File`, `string`, `URLSearchParams`, `FormData`, or just a key-value pair object (`{ [key: string]: any }`).

If the method is `GET`, this value will be set to undefined.

**abortController ([AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController))**

Optional abort controller to perform a fetch abort.

**headers ([Headers](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#Headers))**

Optional Headers object.

**query (`{ [key: string]: any }`)**

Optional key-value pair, this will be converted (and appended) to the request URI.

The value should be a `string`, otherwise use `queryParamsTransformer` callback.

**queryParamsTransormer (IQueryParamTransformer)**

A callback having the following definition:

```typescript
interface IQueryParamTransformer {
	(key: string, value: any, query: any): string
}
```

...it need to have back the `string` version of your custom type parameter.

Have a look at `tests/features.test.ts` to see it in action!

**queryParamsIncludeEmpty (boolean)**

If true, it will include falsy values as empty, example:

```
/example/?a=&b=
```

Defaults to false.

**useCache (boolean)**

If true, it will enable an internal, [Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map) based, cache system.

Every entry for this cache, will use a compound-key containing the *cacheKey*, if provided.

**cacheKey (string)**

An optional alias reference to the current request, *usefull if you are using useCache* parameter as true.

**throw (boolean)**

Defaults to false.

As standard behaviour of fetch, every request will never throw error. But sometimes, in very large applications, you need a centralized API error handler.

If true, when the standard [fetch -> Response.ok](https://developer.mozilla.org/en-US/docs/Web/API/Response/ok) is false the API will throw an error.

The error object will be an instance of `RestError` class.

**throwExcluding (IResponseFilter[])**

Even when you throwing error on failed requests, sometime you may need to filter this errors.

You can do this providing an array of `IResponseFilter`:

```typescript
interface IResponseFilter {
	path?: string;
	method?: HttpMethod;
	statusCode?: HTTPStatusCode;
	cback?: {
		(error: RestError): void
	};
}
```

If a failed request match one of the objects provided, the API will not throw.

Setting throwExcluding will also set `throw` option to `true`.

Have a look at `tests/features.test.ts` to see it in action!

<!-- omit in toc -->
### request`<TResponse, TError = any>`()

*Parameters*:

* HttpMethod (`GET` | `DELETE` | `HEAD` | `OPTIONS` | `POST` | `PUT` | `PATCH` | `LINK`)
* path *(string)*, this will be appended to *host* and *basePath* option
* requestOptions *(IRequestOptions | undefined)*, local request options that will override the global options provided via constructor.

*Returns* `Promise<IResponse<TResponse, TError>>`, where:
 * `TResponse` is the `response.data` type (typescript intellisense)
 * `TError` is the **optional** `error.response.data` type

*Usage*:

```typescript
const client = new RestClient({
	host: `https://server.com`,
	basePath: "/controller",
	responseType: `text`
})
const response = await client.request<string>(`GET`, `/action`);
console.log(response.request.url.href); // -> "https://server.com/controller/action"
console.log(response.data); // -> "sample text"
```

*Usage with error type*:

```typescript
const response = await client.request<string, IBackendError>(`GET`, `/action-with-error`);
const error = response.error;
console.log(error.response?.data?); // -> your error object, with intellisense on your editor
```

<!-- omit in toc -->
### HttpMethod shortcut methods

For every HttpMethod string type, there will be a lower case version as method:

* *get`<T>`()*
* *post`<T>`()*
* *put`<T>`()*
* etc...

...having the following, simplified, parameters:

* path *(string)*
* requestOptions *(IRequestOptions | undefined)*

Every shortcut method will internally call `request()` itself.
Usage:

```typescript
const client = new RestClient({
	host: `https://server.com`,
	basePath: "/controller",
	responseType: `text`
})
const response = await client.get<string>(`/action`);
console.log(response.request.url.href); // -> "https://server.com/controller/action"
```

### Response Object

Properties:

**fetchResponse ([Response](https://developer.mozilla.org/en-US/docs/Web/API/Response))**

**request ([Request (sent) Object](#request-sent-object))**

**error ([RestError](#resterror)`<TError>`)**

**status (HTTPStatusCode)**

**headers ([Headers](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#Headers))**

**data (TResponse | null)**

The response body, leaded by `IRequestOptions.responseType` (for runtime type) and `TResponse` (for Typescript intellisense).

Example:

```typescript
interface IMyObject {
	test: string
}
const client = new RestClient({
	host: `https://server.com`,
	basePath: "/controller",
	responseType: `json`
})
const response = await client.get<IMyObject>(`/action`);
```

The property `response.data` will infer the `IMyObject` interface.

**throwFilter (IResponseFilter)**

When a `IResponseFilter` match the response, this property will expose it.

**repeat()**

A usefull shortcut to repeat the request sent.

This method has the following interface:

```typescript
export interface IRepeat<TResponse, TError = any> {
	(method?: HttpMethod, requestOptions?: IRequestOptions): Promise<IResponse<TResponse, TError>>
}
export interface IRepeat<TResponse, TError = any> {
	(requestOptions?: IRequestOptions): Promise<IResponse<TResponse, TError>>
}
```
Every parameter is optional, you can override every option as usual.

*Usage*
```typescript
const first = await restClient.get<any>("/action");
const second = first.repeat();
```

### Request (sent) Object

This simple interface is used to qualify the Response Object, here you will find details about the request executed to get the response.

**options (IRequestOptions)**

Options used on request.

**url ([URL](https://developer.mozilla.org/en-US/docs/Web/API/URL/URL))**

The URL instance evaluated using `host`, `basePath` and `path`.

**method (HttpMethod)**

HttpMethod used on request.

**body (any | undefined)**

The optional body used, tipically when HttpMethod is `PUT` or `POST`.

## RestError

This class extends the default Javascript Error, it require a template on constructor to qualify a response body, usually provided by backend API's handled exceptions.

```typescript
const response = await restClient.get<any, IBackendError>("/status-code/412");
// intellisense here should work data prop:
const error = response.error?.data;

// ...or just import and create it manually
import { RestError } from "scarlett";
const err = new RestError<IBackendError>();
```

Preoperties:

**isRestError (boolean)**

Always true, it's a simple utility prop that can be used by every kind of Two-Way Binding framework.

**request (IRequest)**

**response (IResponse`<TError>`)**

Where `TError` will be the model type of response body.

**code (string | number)**

It can be the HTTPStatusCode or an internal identifier error string.

**Console Methods:**

Some methods overrides using error code as prefix for messages, example:

```typescript
errorInstance.consoleWarn("Test Message");
// -> [error code] Test Message
```

**consoleTable(...tabularData: any[])**

**consoleWarn(message: string)**

**consoleError(message: string)**

**Methods:**

**setRequest(request: IRequest)**

Set the `request` object for the current error instance.

**setResponse(response: IResponse)**

Set the `response` object for the current error instance.

**throwFilterMatch(filter: IResponseFilter) => boolean**

Check if `response` object match with the `filter` provided.

This method is used internally by `RestClient`.

## Advanced usage

### Extending

You can extend the base class for your specific needs as follows:

```typescript
import RestClient from `scarlett`

class MyRestFactory1 extends RestClient {
	constructor() {
		super({
			host: "https://mybackend.com",
			basePath: "/my-controller"
		});
	}
	items() {
		return this.get("/action");
	}
	item(id: number) {
		return this.get(`/action/${id}`);
	}
}
```

You can even import types/interfaces exported from the module itself:

```typescript
import RestClient, { IRequestOptions } from `scarlett`

class MyRestFactory2 extends RestClient {
	constructor(options: IRequestOptions) {
		options.host = "https://mybackend.com";
		options.basePath = "/my-controller";
		options.throw = true;
		super(options);
	}
	// your methods here...
}
```

### Importing extras

```typescript
import {
	RestError, // Rest error utility class

	// Utility types:
	HttpMethod,
	HTTPStatusCode,

	// Extra/Internal interfaces
	IRequestOptions,
	IRequestQueryOptions,
	IResponse,
	IRequest,
	IResponseFilter
} from `scarlett`;
```

## Testing

To develop or testing purposes:

1. `git clone [repo_url]`
2. `cd` to the root project folder (`package.json`)
3. `npm i` or `yarn` to install packages

To execute tests, just execute on project root:

`npm run test` or `npm run test`

## Inspired by...

* [axios](https://github.com/axios/axios)
* DotNet Core's [HttpClientFactory](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/http-requests#typed-clients)

## Why this name?

Maybe I'm a huge fan of that beautiful American actress...
